<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" type="image/x-icon" href="./images/favicon 32_32.png">
    <title>Cyoda API Documentation</title>

    <!-- Markdown URL redirect for ?md= parameter -->
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const mdParam = urlParams.get('md');

        if (mdParam) {
            const parts = mdParam.split('/');
            const section = parts[0];
            const resourcePath = parts[1];

            if (section && resourcePath) {
                const githubRawUrl = `https://raw.githubusercontent.com/Cyoda-platform/cyoda-docs/refs/heads/main/dist/resources/${section}/${resourcePath}.md`;
                window.location.href = githubRawUrl;
            }
        }
    </script>

    <!-- Stoplight Elements -->
    <script src="./js/elements.min.js"></script>
    <link rel="stylesheet" href="./css/elements.min.css">
    <link rel="stylesheet" href="./css/custom.css"/>

    <!-- Font Awesome for GitHub icon -->
    <link rel="stylesheet" href="./css/font-awesome.all.min.css"/>

    <!-- Marked.js for markdown parsing -->
    <script src="./js/marked.min.js"></script>

    <!-- Mermaid.js for diagram rendering -->
    <script src="./js/mermaid.min.js"></script>

</head>
<body>

<header>
    <div class="logo">
        <!--suppress CheckImageSize -->
        <img width="30" src="./images/cyoda-icon.png" alt="logo">Cyoda Documentation
    </div>
    <a class="github-link" href="https://github.com/Cyoda-platform" target="_blank" title="View on GitHub">
        <i class="fab fa-github"></i>
    </a>
</header>

<nav class="main-nav">
    <div class="nav-container">
        <button class="nav-tab active" data-content="api">
            <i class="fas fa-code"></i> API Reference
        </button>
        <button class="nav-tab" data-content="guides">
            <i class="fas fa-book"></i> Dev Guides
        </button>
        <button class="nav-tab" data-content="concepts">
            <i class="fas fa-lightbulb"></i> Concepts and Ideas
        </button>
        <button class="nav-tab" data-content="architecture">
            <i class="fas fa-sitemap"></i> Architecture
        </button>
        <button class="nav-tab" data-content="platform">
            <i class="fas fa-info-circle"></i> Cloud Info
        </button>
    </div>
</nav>

<main class="main-content">
    <!-- Cyoda Cloud Info Content -->
    <div id="platform-content" class="content-section">
        <div class="resource-nav">
            <div class="resource-links">
                <button class="resource-link" data-resource="platform/cyoda-cloud-status">
                    <i class="fas fa-heartbeat"></i> Current Status
                </button>
                <button class="resource-link" data-resource="platform/cloud-service-details">
                    <i class="fas fa-info-circle"></i> Service Details
                </button>
                <button class="resource-link" data-resource="platform/entitlements">
                    <i class="fas fa-layer-group"></i> Subscription Tiers
                </button>
                <button class="resource-link" data-resource="platform/roadmap">
                    <i class="fas fa-road"></i> Roadmap
                </button>
            </div>

            <!-- Copy Page Dropdown -->
            <div class="copy-page-dropdown" style="display: none;">
                <button class="copy-page-btn">
                    <i class="fas fa-copy"></i> Copy Page <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu">
                    <a href="#" class="dropdown-item view-markdown">
                        <i class="fas fa-file-alt"></i>
                        <div class="dropdown-content">
                            <div class="dropdown-title">View Markdown</div>
                            <div class="dropdown-subtitle">See the raw Markdown for this page</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        <div id="platform-markdown" class="markdown-content"></div>
    </div>

    <!-- API Documentation Content -->
    <div id="api-content" class="content-section active">
        <elements-api
                apiDescriptionUrl="./openapi/openapi.json"
                hideTryIt="false"
                layout="responsive"
                router="hash">
        </elements-api>
    </div>

    <!-- Developer Guides Content -->
    <div id="guides-content" class="content-section">
        <div class="resource-nav">
            <div class="resource-links">
                <button class="resource-link" data-resource="guides/cyoda-design-principles">
                    <i class="fas fa-compass"></i> Design Principles
                </button>
                <button class="resource-link" data-resource="guides/provision-environment">
                    <i class="fas fa-rocket"></i> Provision Environment
                </button>
                <button class="resource-link" data-resource="guides/workflow-config-guide">
                    <i class="fas fa-project-diagram"></i> Workflow Config
                </button>
                <button class="resource-link" data-resource="guides/authentication-authorization">
                    <i class="fas fa-shield-alt"></i> Connecting
                </button>
                <button class="resource-link" data-resource="guides/api-saving-and-getting-data">
                    <i class="fas fa-database"></i> API: Saving and Getting Data
                </button>
                <button class="resource-link" data-resource="guides/sql-and-trino">
                    <i class="fas fa-search"></i> SQL Querying
                </button>
            </div>

            <!-- Copy Page Dropdown -->
            <div class="copy-page-dropdown" style="display: none;">
                <button class="copy-page-btn">
                    <i class="fas fa-copy"></i> Copy Page <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu">
                    <a href="#" class="dropdown-item view-markdown">
                        <i class="fas fa-file-alt"></i>
                        <div class="dropdown-content">
                            <div class="dropdown-title">View Markdown</div>
                            <div class="dropdown-subtitle">See the raw Markdown for this page</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        <div id="guides-markdown" class="markdown-content"></div>
    </div>

    <!-- Concepts and Ideas Content -->
    <div id="concepts-content" class="content-section">
        <div class="resource-nav">
            <div class="resource-links">
                <button class="resource-link" data-resource="concepts/edbms">
                    <i class="fas fa-cogs"></i> EDBMS
                </button>
                <button class="resource-link" data-resource="concepts/event-driven-architecture">
                    <i class="fas fa-project-diagram"></i> Event-Driven Architecture
                </button>
                <button class="resource-link" data-resource="concepts/cpl-overview">
                    <i class="fas fa-layer-group"></i> Cyoda Platform Library
                </button>
            </div>

            <!-- Copy Page Dropdown -->
            <div class="copy-page-dropdown" style="display: none;">
                <button class="copy-page-btn">
                    <i class="fas fa-copy"></i> Copy Page <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu">
                    <a href="#" class="dropdown-item view-markdown">
                        <i class="fas fa-file-alt"></i>
                        <div class="dropdown-content">
                            <div class="dropdown-title">View Markdown</div>
                            <div class="dropdown-subtitle">See the raw Markdown for this page</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        <div id="concepts-markdown" class="markdown-content"></div>
    </div>

    <!-- Architecture Content -->
    <div id="architecture-content" class="content-section">
        <div class="resource-nav">
            <div class="resource-links">
                <button class="resource-link" data-resource="architecture/cyoda-cloud-architecture">
                    <i class="fas fa-server"></i> Cloud Architecture
                </button>
            </div>

            <!-- Copy Page Dropdown -->
            <div class="copy-page-dropdown" style="display: none;">
                <button class="copy-page-btn">
                    <i class="fas fa-copy"></i> Copy Page <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu">
                    <a href="#" class="dropdown-item view-markdown">
                        <i class="fas fa-file-alt"></i>
                        <div class="dropdown-content">
                            <div class="dropdown-title">View Markdown</div>
                            <div class="dropdown-subtitle">See the raw Markdown for this page</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        <div id="architecture-markdown" class="markdown-content"></div>
    </div>


</main>

<footer>
    <div class="footer-content">
        <div class="footer-github">
            Documentation hosted on GitHub Pages | <a href="https://github.com/Cyoda-platform/cyoda-docs" target="_blank">Contribute</a>
        </div>

        <div class="footer-links">
            <a href="https://www.cyoda.com" target="_blank">Visit Cyoda</a>
            <a href="https://www.cyoda.com/privacy-policy" target="_blank">Privacy Notice</a>
            <a href="https://www.cyoda.com/terms-of-service" target="_blank">Site Terms</a>
            <span>© 2025 CYODA Ltd.</span>
            <span>Licensed under <a rel="license" href="https://creativecommons.org/licenses/by/4.0/" target="_blank" title="Creative Commons Attribution 4.0 International License">CC BY 4.0</a></span>
        </div>
    </div>
</footer>



<!--suppress ExceptionCaughtLocallyJS -->
<script>
// Navigation and content loading functionality
class CyodaDocumentation {
    constructor() {
        this.currentSection = 'api';
        this.currentResource = null;
        this.loadedResources = new Map();
        this.init();
    }

    init() {
        this.initializeMermaid();
        this.bindEvents();
        this.setupBrowserHistory();
        this.loadInitialContent();
    }

    setupBrowserHistory() {
        // Handle browser back/forward buttons
        window.addEventListener('popstate', (event) => {
            if (event.state) {
                this.restoreFromHistoryState(event.state);
            } else {
                // Parse URL and navigate accordingly
                this.parseAndNavigateFromUrl();
            }
        });

        // Parse initial URL on page load
        this.parseAndNavigateFromUrl();
    }

    parseAndNavigateFromUrl() {
        const hash = window.location.hash.substring(1); // Remove #
        if (!hash) {
            this.switchSection('api', false);
            this.replaceHistoryState('api', null);
            return;
        }

        const parts = hash.split('/');
        const section = parts[0];
        const resourcePath = parts.slice(1).join('/');

        if (this.isValidSection(section)) {
            this.switchSection(section, false);

            if (resourcePath) {
                const fullResourcePath = `${section}/${resourcePath}`;
                this.loadResource(fullResourcePath, section, false);

                // Update active resource link
                const resourceLink = document.querySelector(`[data-resource="${fullResourcePath}"]`);
                if (resourceLink) {
                    resourceLink.closest('.resource-links').querySelectorAll('.resource-link').forEach(l => l.classList.remove('active'));
                    resourceLink.classList.add('active');
                }

                this.replaceHistoryState(section, fullResourcePath);
            } else {
                this.replaceHistoryState(section, null);
            }
        } else {
            // Invalid section, default to API
            this.switchSection('api', false);
            this.replaceHistoryState('api', null);
        }
    }

    isValidSection(section) {
        const validSections = ['api', 'guides', 'concepts', 'architecture', 'platform'];
        return validSections.includes(section);
    }

    pushHistoryState(section, resource = null) {
        const state = { section, resource };
        const url = this.buildUrl(section, resource);
        history.pushState(state, '', url);
    }

    replaceHistoryState(section, resource = null) {
        const state = { section, resource };
        const url = this.buildUrl(section, resource);
        history.replaceState(state, '', url);
    }

    buildUrl(section, resource = null) {
        let url = `#${section}`;
        if (resource) {
            url += `/${resource.replace(/^[^/]+\//, '')}`;
        }
        return url;
    }

    restoreFromHistoryState(state) {
        this.switchSection(state.section, false);
        if (state.resource) {
            this.loadResource(state.resource, state.section, false);

            // Update active resource link
            const resourceLink = document.querySelector(`[data-resource="${state.resource}"]`);
            if (resourceLink) {
                resourceLink.closest('.resource-links').querySelectorAll('.resource-link').forEach(l => l.classList.remove('active'));
                resourceLink.classList.add('active');
            }
        }
    }

    initializeMermaid() {
        // Initialize Mermaid with custom configuration
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            themeVariables: {
                primaryColor: '#4FB8B0',
                primaryTextColor: '#2c3e50',
                primaryBorderColor: '#4FB8B0',
                lineColor: '#6c757d',
                secondaryColor: '#f8f9fa',
                tertiaryColor: '#e9ecef'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            securityLevel: 'loose'
        });

        // Configure marked.js to handle code blocks and generate heading IDs
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang === 'mermaid') {
                    return code;
                }
                return code;
            },
            langPrefix: 'language-'
        });

        // Add custom renderer for headings to generate IDs
        const renderer = new marked.Renderer();
        renderer.heading = function(text, level) {
            const escapedText = text.toLowerCase().replace(/[^\w]+/g, '-');
            return `<h${level} id="${escapedText}">${text}</h${level}>`;
        };
        marked.setOptions({ renderer: renderer });
    }

    bindEvents() {
        // Logo click to go home
        document.querySelector('.logo').addEventListener('click', () => {
            this.switchSection('api');
        });

        // Main navigation tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const contentType = e.currentTarget.dataset.content;
                this.switchSection(contentType);
            });
        });

        // Resource links
        document.querySelectorAll('.resource-link').forEach(link => {
            link.addEventListener('click', (e) => {
                const resourceName = e.currentTarget.dataset.resource;
                const section = e.currentTarget.closest('.content-section').id.replace('-content', '');
                this.loadResource(resourceName, section);

                // Update active state
                e.currentTarget.closest('.resource-links').querySelectorAll('.resource-link').forEach(l => l.classList.remove('active'));
                e.currentTarget.classList.add('active');
            });
        });

        // Copy Page dropdown events
        this.bindCopyPageEvents();
    }

    switchSection(sectionName, updateHistory = true) {
        if (updateHistory && sectionName !== this.currentSection) {
            this.pushHistoryState(sectionName);
        }

        // Update nav tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-content="${sectionName}"]`).classList.add('active');

        // Update content sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(`${sectionName}-content`).classList.add('active');

        this.currentSection = sectionName;

        // Reset current resource when switching sections
        this.currentResource = null;
        this.updateCopyPageVisibility();

        // Load default resource for non-API sections
        if (sectionName !== 'api') {
            this.loadDefaultResource(sectionName);
        }
    }

    loadDefaultResource(section) {
        const defaultResources = {
            'guides': 'guides/authentication-authorization',
            'concepts': 'concepts/edbms',
            'architecture': 'architecture/cyoda-cloud-architecture',
            'platform': 'platform/cyoda-cloud-status'
        };

        const defaultResource = defaultResources[section];
        if (defaultResource) {
            this.loadResource(defaultResource, section);

            // Set active state on default resource link
            const resourceLink = document.querySelector(`[data-resource="${defaultResource}"]`);
            if (resourceLink) {
                resourceLink.closest('.resource-links').querySelectorAll('.resource-link').forEach(l => l.classList.remove('active'));
                resourceLink.classList.add('active');
            }
        }
    }

    async loadResource(resourceName, section, updateHistory = true) {
        if (updateHistory) {
            this.pushHistoryState(section, resourceName);
        }

        // Update current resource for copy page functionality
        this.currentResource = resourceName;
        this.updateCopyPageVisibility();

        try {
            // Check if already loaded
            if (this.loadedResources.has(resourceName)) {
                this.displayResource(this.loadedResources.get(resourceName), section);
                return;
            }

            // Show loading state
            const markdownContainer = document.getElementById(`${section}-markdown`);
            markdownContainer.innerHTML = '<div class="loading">Loading...</div>';

            // Fetch markdown content
            const response = await fetch(`./resources/${resourceName}.md`);
            if (!response.ok) {
                throw new Error(`Failed to load ${resourceName}`);
            }

            const markdownText = await response.text();
            const htmlContent = marked.parse(markdownText);

            // Cache the content
            this.loadedResources.set(resourceName, htmlContent);

            // Display the content
            this.displayResource(htmlContent, section);

        } catch (error) {
            console.error('Error loading resource:', error);
            const markdownContainer = document.getElementById(`${section}-markdown`);
            markdownContainer.innerHTML = `<div class="error">Failed to load ${resourceName}. Please try again.</div>`;
        }
    }

    displayResource(htmlContent, section) {
        const markdownContainer = document.getElementById(`${section}-markdown`);
        markdownContainer.innerHTML = htmlContent;

        // Process GitHub-style callouts
        this.processCallouts(markdownContainer);

        // Process Mermaid diagrams after content is rendered
        this.processMermaidDiagrams(markdownContainer);

        // Add anchor link handling
        this.setupAnchorLinks(markdownContainer);
    }

    processCallouts(container) {
        // Find all blockquotes that start with [!TYPE]
        const blockquotes = container.querySelectorAll('blockquote');

        blockquotes.forEach(blockquote => {
            const firstChild = blockquote.firstElementChild;
            if (firstChild && firstChild.tagName === 'P') {
                const text = firstChild.textContent.trim();
                const calloutMatch = text.match(/^\[!(INFO|NOTE|WARNING|TIP|CAUTION)]\s*(.*)$/i);

                if (calloutMatch) {
                    const calloutType = calloutMatch[1].toLowerCase();
                    const title = calloutMatch[2] || calloutType.toUpperCase();

                    // Set data attributes
                    blockquote.setAttribute('data-callout', calloutType);
                    blockquote.setAttribute('data-callout-title', title);

                    // Remove the [!TYPE] text from the first paragraph
                    if (calloutMatch[2].trim()) {
                        // Title is already set in data-callout-title, remove the content
                        firstChild.remove();
                    } else {
                        firstChild.remove();
                    }
                }
            }
        });
    }

    setupAnchorLinks(container) {
        // Handle clicks on anchor links within the same document
        container.querySelectorAll('a[href^="#"]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                const targetElement = container.querySelector(`#${targetId}`);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // Handle clicks on relative markdown links to other documents
        container.querySelectorAll('a[href$=".md"]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const href = link.getAttribute('href');
                const resourceName = href.replace('.md', '');

                // Determine which section this resource belongs to
                const section = this.getResourceSection(resourceName);
                if (section) {
                    this.switchSection(section);
                    this.loadResource(`${section}/${resourceName}`, section);

                    // Update active state
                    const resourceLink = document.querySelector(`[data-resource="${section}/${resourceName}"]`);
                    if (resourceLink) {
                        resourceLink.closest('.resource-links').querySelectorAll('.resource-link').forEach(l => l.classList.remove('active'));
                        resourceLink.classList.add('active');
                    }
                }
            });
        });

        // Handle clicks on API Documentation links
        container.querySelectorAll('a[href*="#api"]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                this.switchSection('api');
            });
        });
    }

    getResourceSection(resourceName) {
        const resourceMap = {
            'cyoda-cloud-status': 'platform',
            'cyoda-cloud-caveats': 'platform',
            'entitlements': 'platform',
            'roadmap': 'platform',
            'cloud-service-details': 'platform',
            'authentication-authorization': 'guides',
            'api-saving-and-getting-data': 'guides',
            'sql-and-trino': 'guides',
            'cyoda-design-principles': 'guides',
            'provision-environment': 'guides',
            'workflow-config-guide': 'guides',
            'cpl-overview': 'concepts',
            'edbms': 'concepts',
            'event-driven-architecture': 'concepts',
            'cyoda-cloud-architecture': 'architecture'
        };
        return resourceMap[resourceName];
    }

    async processMermaidDiagrams(container) {
        // Find all code blocks with language 'mermaid'
        const mermaidBlocks = container.querySelectorAll('pre code.language-mermaid, pre code[class*="language-mermaid"]');

        for (let i = 0; i < mermaidBlocks.length; i++) {
            const codeBlock = mermaidBlocks[i];
            const mermaidCode = codeBlock.textContent;

            try {
                // Create a unique ID for this diagram
                const diagramId = `mermaid-diagram-${Date.now()}-${i}`;

                // Create a div to hold the rendered diagram
                const diagramDiv = document.createElement('div');
                diagramDiv.id = diagramId;
                diagramDiv.className = 'mermaid-diagram';

                // Replace the code block with the diagram div
                const preElement = codeBlock.closest('pre');
                preElement.parentNode.replaceChild(diagramDiv, preElement);

                // Render the Mermaid diagram
                const { svg } = await mermaid.render(diagramId + '-svg', mermaidCode);
                diagramDiv.innerHTML = svg;

            } catch (error) {
                console.error('Error rendering Mermaid diagram:', error);

                // Show error message in place of diagram
                const errorDiv = document.createElement('div');
                errorDiv.className = 'mermaid-error';
                errorDiv.innerHTML = `
                    <div class="error">
                        <strong>Error rendering diagram:</strong> ${error.message}
                        <details>
                            <summary>Show diagram code</summary>
                            <pre><code>${mermaidCode}</code></pre>
                        </details>
                    </div>
                `;

                const preElement = codeBlock.closest('pre');
                preElement.parentNode.replaceChild(errorDiv, preElement);
            }
        }
    }

    loadInitialContent() {
        // Only pre-load if we're on the default API section
        if (this.currentSection === 'api') {
            this.loadDefaultResource('guides');
            this.loadDefaultResource('concepts');
        }
    }

    bindCopyPageEvents() {
        // Handle all copy page buttons
        document.querySelectorAll('.copy-page-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdown = btn.closest('.copy-page-dropdown');
                const menu = dropdown.querySelector('.dropdown-menu');

                // Close all other dropdowns
                document.querySelectorAll('.copy-page-dropdown').forEach(otherDropdown => {
                    if (otherDropdown !== dropdown) {
                        otherDropdown.querySelector('.dropdown-menu').classList.remove('show');
                        otherDropdown.querySelector('.copy-page-btn').classList.remove('active');
                    }
                });

                // Toggle current dropdown
                menu.classList.toggle('show');
                btn.classList.toggle('active');
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.copy-page-dropdown')) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
                document.querySelectorAll('.copy-page-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
        });

        // Handle view markdown clicks
        document.querySelectorAll('.view-markdown').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                this.openMarkdownView();
            });
        });
    }

    updateCopyPageVisibility() {
        // Show dropdown only in the current active section when viewing a documentation page
        document.querySelectorAll('.copy-page-dropdown').forEach(dropdown => {
            const section = dropdown.closest('.content-section');
            const sectionId = section.id.replace('-content', '');

            if (sectionId === this.currentSection && this.currentSection !== 'api' && this.currentResource) {
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        });
    }

    openMarkdownView() {
        if (!this.currentResource) return;

        const resourcePath = this.currentResource.replace(/^[^/]+\//, ''); // Remove section prefix

        // Use query parameter approach that we know works: ?md=section/resource
        const markdownUrl = `/?md=${this.currentSection}/${resourcePath}`;

        // Open the markdown URL in new tab
        window.open(markdownUrl, '_blank');
    }


}

// Initialize the documentation app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new CyodaDocumentation();
});
</script>

</body>
</html>
